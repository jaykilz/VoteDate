<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lịch chọn ngày — 20/10 → 20/11</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0;padding:0}
    body{padding:18px;background:#f6f7fb;color:#111}
    h1{font-size:20px;margin:0 0 12px}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(22,27,60,0.08);padding:16px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .controls button{padding:8px 12px;border-radius:8px;border:1px solid #e6e9f2;background:#fff;cursor:pointer}
    .table-wrap{overflow:auto}
    table{border-collapse:collapse;width:100%;min-width:900px}
    th,td{border:1px solid #e6e9f2;padding:6px 8px;text-align:center;font-size:13px}
    th.sticky{position:sticky;left:0;background:#fff;z-index:3}
    td.left{position:sticky;left:0;background:#fff;z-index:2;text-align:left}
    th.date{width:72px}
    .legend{margin-top:12px;font-size:13px}
    .actions{margin-top:12px;display:flex;gap:8px}
    input[type=file]{display:none}
    .small{font-size:12px;padding:6px 10px}
    .download-link{display:inline-block}
    @media (max-width:720px){th.date{width:64px}}
  </style>
</head>
<body>
  <h1>Lịch chọn ngày — 20/10 → 20/11</h1>
  <div class="card">
    <div class="controls">
      <button id="fillSample">Điền mẫu (A–F)</button>
      <button id="clearAll">Xóa tất cả</button>
      <button id="toggleColors">Bật/Tắt màu</button>
      <label style="margin-left:auto">Tên tạm: <input id="namesCount" type="number" min="1" max="20" value="6" style="width:64px;margin-left:6px"></label>
      <button id="applyNames">Tạo tên A..</button>
    </div>

    <div class="table-wrap">
      <table id="sheet">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="actions">
      <button id="exportCsv">Tải CSV</button>
      <button id="exportJson">Tải JSON</button>
      <label class="download-link"><input id="importFile" type="file" accept="application/json,text/csv"> <button id="btnImport">Import</button></label>
      <button id="copyClipboard">Sao chép (CSV) vào clipboard</button>
    </div>

    <div class="legend">Ghi chú: Click ô để chọn/ bỏ chọn. Tải file để lưu, import để tải lại. Bạn có thể upload file HTML lên GitHub Pages hoặc mở trực tiếp trên máy để dùng.</div>
  </div>

  <script>
    // Thiết lập ngày
    const start = new Date(2025,9,20); // tháng: 0-based -> 9 = Oct
    const end = new Date(2025,10,20);  // 10 = Nov

    function formatDate(d){
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      return dd + '/' + mm;
    }

    function generateDates(start,end){
      const arr=[];
      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) arr.push(new Date(d));
      return arr;
    }

    const dates = generateDates(start,end).map(d=>formatDate(d));

    // Tạo bảng
    const thead = document.getElementById('thead');
    const tbody = document.getElementById('tbody');

    function buildHeader(){
      thead.innerHTML='';
      const tr = document.createElement('tr');
      const th0 = document.createElement('th'); th0.className='sticky'; th0.textContent='Tên'; tr.appendChild(th0);
      dates.forEach(d=>{ const th=document.createElement('th'); th.className='date'; th.textContent=d; tr.appendChild(th)});
      thead.appendChild(tr);
    }

    let names = [];
    function defaultNames(n){
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const out=[]; for(let i=0;i<n;i++){ out.push(letters[i] || ('P'+(i+1))) }
      return out;
    }

    function buildBody(){
      tbody.innerHTML='';
      names.forEach((name,r)=>{
        const tr=document.createElement('tr');
        const td0=document.createElement('td'); td0.className='left'; td0.textContent=name; tr.appendChild(td0);
        dates.forEach((d,c)=>{
          const td=document.createElement('td');
          const chk=document.createElement('input'); chk.type='checkbox'; chk.dataset.r=r; chk.dataset.c=c;
          chk.addEventListener('change',onChangeCell);
          td.appendChild(chk);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function onChangeCell(e){
      const el = e.target; if(window.coloring) applyColor(el);
    }

    // Controls
    document.getElementById('fillSample').addEventListener('click',()=>{
      names = defaultNames(6); document.getElementById('namesCount').value = 6; rebuild();
      // random tick sample
      document.querySelectorAll('#tbody input[type=checkbox]').forEach((cb,i)=>{ cb.checked = Math.random()>.5; if(window.coloring) applyColor(cb)});
    });
    document.getElementById('clearAll').addEventListener('click',()=>{
      document.querySelectorAll('#tbody input[type=checkbox]').forEach(cb=>{ cb.checked=false; cb.parentElement.style.background=''; });
    });
    document.getElementById('toggleColors').addEventListener('click',()=>{ window.coloring = !window.coloring; applyAllColors(); });
    document.getElementById('applyNames').addEventListener('click',()=>{
      const n = Math.max(1, Math.min(20, parseInt(document.getElementById('namesCount').value||6)));
      names = defaultNames(n); rebuild();
    });

    function rebuild(){ buildHeader(); buildBody(); }

    // Coloring
    window.coloring = true;
    function applyColor(chk){
      const td = chk.parentElement;
      td.style.background = chk.checked ? 'rgba(76,175,80,0.12)' : '';
    }
    function applyAllColors(){
      document.querySelectorAll('#tbody input[type=checkbox]').forEach(cb=>{ applyColor(cb); });
    }

    // Export CSV/JSON
    function tableToArray(){
      const rows=[['Tên', ...dates]];
      names.forEach((name,r)=>{
        const row=[name];
        dates.forEach((d,c)=>{
          const cb = document.querySelector(`#tbody input[data-r='${r}'][data-c='${c}']`);
          row.push(cb && cb.checked ? '1' : '');
        });
        rows.push(row);
      });
      return rows;
    }

    function arrayToCsv(rows){ return rows.map(r=>r.map(cell=>`"${String(cell||'').replace(/"/g,'""')}"`).join(',')).join('\n'); }

    document.getElementById('exportCsv').addEventListener('click',()=>{
      const csv = arrayToCsv(tableToArray());
      downloadBlob(csv,'lich_chon_ngay.csv','text/csv');
    });
    document.getElementById('exportJson').addEventListener('click',()=>{
      const data = {names,dates,values:[]};
      names.forEach((name,r)=>{
        const row=[]; dates.forEach((d,c)=>{ const cb=document.querySelector(`#tbody input[data-r='${r}'][data-c='${c}']`); row.push(!!(cb && cb.checked)); }); data.values.push(row);
      });
      downloadBlob(JSON.stringify(data),'lich_chon_ngay.json','application/json');
    });

    function downloadBlob(text,filename,type){
      const a = document.createElement('a'); const blob = new Blob([text],{type}); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),5000);
    }

    // Import
    document.getElementById('btnImport').addEventListener('click',()=> document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change',async(e)=>{
      const f = e.target.files[0]; if(!f) return; const txt = await f.text();
      try{
        if(f.name.endsWith('.json')){
          const data = JSON.parse(txt);
          names = data.names || names; rebuild();
          data.values && data.values.forEach((row,r)=> row.forEach((v,c)=>{ const cb=document.querySelector(`#tbody input[data-r='${r}'][data-c='${c}']`); if(cb) cb.checked = !!v;}));
          applyAllColors();
        } else {
          // CSV: simple parse
          const lines = txt.trim().split(/\r?\n/).map(l=>l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(cell=>cell.replace(/^"|"$/g,'')));
          // first row is header
          const header = lines[0].slice(1);
          // replace dates only if length matches
          if(header.length === dates.length) console.log('CSV date header matches');
          names = lines.slice(1).map(r=>r[0]); rebuild();
          lines.slice(1).forEach((r,ri)=> r.slice(1).forEach((cell,ci)=>{ const cb=document.querySelector(`#tbody input[data-r='${ri}'][data-c='${ci}']`); if(cb) cb.checked = (cell.trim()!=='' && cell.trim()!=='0'); }));
          applyAllColors();
        }
      }catch(err){ alert('Không thể import file: ' + err.message) }
    });

    // Clipboard copy CSV
    document.getElementById('copyClipboard').addEventListener('click',async ()=>{
      const csv = arrayToCsv(tableToArray());
      try{ await navigator.clipboard.writeText(csv); alert('Đã sao chép CSV vào clipboard'); }catch(e){ alert('Không thể sao chép tự động. Tải file CSV thay thế.'); downloadBlob(csv,'lich_chon_ngay.csv','text/csv'); }
    });

    // Init
    names = defaultNames(6);
    rebuild();
    applyAllColors();
  </script>
</body>
</html>
